image: registry.lunes.io/blockchain/production/lunespy:latest

stages:
    - test
    - merge
    - deploy

before_script:
    - pip install -r requeriments.txt

CreateReportTests:
    stage: test
    only:
        refs:
            - pre-prod
    script:
        - python3 -m pytest --junitxml=report.xml
    artifacts:
        when: always
        reports:
            junit: report.xml
    after_script:
      - py3clean .

CreateAutoMR:
    stage: merge
    needs:
      - job: "CreateReportTests"
    script:
        - python3 ./.gitlab/scripts/auto-MR.py \
            $CI_SERVER_URL \
            "AUTO MERGE $CI_COMMIT_BRANCH to test-ci" \
            "<h1>Merging because test passed</h1><br>-> <h2>$CI_COMMIT_MESSAGE</h2>" \
            $GITLAB_USER_ID \
            $CI_PROJECT_ID \
            $CI_COMMIT_BRANCH \
            "main" \
            $TOKEN

PublishPackage:
    only:
        refs:
            - main
    stage: deploy
    script:
        - echo "Successfully Published Package "
        #- poetry build
        #- poetry publish